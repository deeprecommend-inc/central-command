# Web操作エージェント with プロキシ & ユーザーエージェント管理

## 目的
プロンプトからWeb操作エージェントを実行する際に、プロキシローテーションとユーザーエージェントを使用する

## 達成すること
- プロキシローテーションが確立されている（BrightData）
- ユーザーエージェント / 住宅IPが確立されている（Mulogin）
- browser-useでWeb操作エージェントを実行できる）
- 並列ブラウザセッション管理（5並列）

## 実装方針

- スローガンは「無駄がない、全てがある。」
- 並列実装し、嘘は排除すること
- 常に最小構成でシンプルにしようと心がけること
- 不要になったフォルダやファイルは随時削除すること
- 絵文字は使わない

## 1. システムアーキテクチャ

```text
[ CLI / API ] → [ コアコントローラー ] → [ ワークマネージャー ]
      ↓                  ↓                      ↓
[ 設定ファイル ]  [ リソースマネージャー ]   [ ブラウザワーカー群 ]
```

## 2. コアコンポーネント設計

### 2.1 リソース管理モジュール

```python
class ResourceManager:
    # プロキシ管理（BrightData）
    - プロキシプールの初期化
    - プロキシヘルスチェック
    - ローテーションロジック（使用回数、応答時間、成功率に基づく）

    # ユーザーエージェント管理
    - UAプールの管理（OS、ブラウザバージョン、デバイスタイプの多様化）
    - フィンガープリント生成
    - セッションごとのUA固定
```

### 2.2 ブラウザ自動化モジュール（browser-use）

```python
class BrowserWorker:
    # セッション設定
    - プロキシ設定適用
    - ユーザーエージェント設定
    - キャッシュ・Cookie管理

    # Web操作フロー
    - プロンプトに基づくタスク実行
    - ページナビゲーション
    - 要素の操作（クリック、入力、スクロール）
    - スクリーンショット取得
    - データ抽出
```

### 2.3 並列処理コントローラー

```python
class ParallelController:
    # 並列処理管理
    - 5並列のブラウザセッション制御
    - リソース割り当て最適化
    - 負荷分散

    # エラーハンドリング
    - プロキシ切断時の自動切り替え
    - 再試行メカニズム（指数バックオフ）
```

## 3. 実装ロジック

### 3.1 プロキシローテーション（BrightData）

```text
1. BrightData APIからプロキシ取得
   ↓
2. プロキシ分類（国、速度、タイプ）
   ↓
3. セッションごとのプロキシ割り当て
   ↓
4. パフォーマンス監視
```

### 3.2 ユーザーエージェント管理

```text
1. UAテンプレートのロード
   ↓
2. 環境変数生成（解像度、言語、タイムゾーン）
   ↓
3. セッションへの適用
   ↓
4. 一貫性の維持（同一セッション内）
```

## 4. 技術スタック

### コア
- 自動化フレームワーク: browser-use / Playwright
- プロキシサービス: BrightData
- データベース: SQLite（軽量）またはPostgreSQL
- 設定管理: python-dotenv

### 必要なパッケージ
```bash
pip install browser-use playwright fake-useragent aiohttp python-dotenv loguru tenacity pydantic
```

## 5. 使用例

```python
from web_agent import WebAgent

agent = WebAgent(
    proxy_config="brightdata",
    parallel_sessions=5
)

# プロンプトでタスク実行
result = await agent.run("https://example.com にアクセスしてタイトルを取得")
```
